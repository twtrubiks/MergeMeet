# ä¿¡ä»»åˆ†æ•¸ç³»çµ±ï¼ˆTrust Score Systemï¼‰

## ğŸ“‹ ç³»çµ±æ¦‚è¿°

ä¿¡ä»»åˆ†æ•¸ç³»çµ±æ˜¯ MergeMeet å¹³å°çš„ä¿¡è­½ç®¡ç†æ©Ÿåˆ¶ï¼Œé€éè‡ªå‹•è¿½è¹¤ç”¨æˆ¶è¡Œç‚ºä¾†ç¶­è­·å¹³å°å¥åº·åº¦èˆ‡å®‰å…¨æ€§ã€‚

### æ ¸å¿ƒç›®æ¨™

1. **çå‹µæ­£å‘è¡Œç‚º** - é¼“å‹µç”¨æˆ¶å®Œæˆé©—è­‰ã€ç©æ¥µäº’å‹•
2. **æ‡²ç½°è² å‘è¡Œç‚º** - éåˆ¶é•è¦ã€é¨·æ“¾ã€è©é¨™ç­‰ä¸ç•¶è¡Œç‚º
3. **å„ªåŒ–é…å°å“è³ª** - å„ªå…ˆæ¨è–¦é«˜ä¿¡ä»»åº¦ç”¨æˆ¶
4. **è‡ªå‹•åŠŸèƒ½é™åˆ¶** - é™åˆ¶ä½ä¿¡ä»»ç”¨æˆ¶çš„ç ´å£è¡Œç‚º

---

## ğŸ¯ åˆ†æ•¸ç³»çµ±è¨­è¨ˆ

### åˆ†æ•¸ç¯„åœ

| åˆ†æ•¸ç¯„åœ | ç‹€æ…‹ | èªªæ˜ |
|----------|------|------|
| 70-100 | é«˜åº¦ä¿¡ä»» | é…å°æ’åºå„ªå…ˆï¼Œç„¡é™åˆ¶ |
| 50-69 | æ­£å¸¸ | æ–°ç”¨æˆ¶é è¨­å€¼ï¼Œæ­£å¸¸ä½¿ç”¨ |
| 30-49 | éœ€é—œæ³¨ | é…å°æ’åºç•¥é™ï¼Œå»ºè­°æ”¹å–„è¡Œç‚º |
| 20-29 | å—é™ | é…å°æ’åºå¤§å¹…é™ä½ï¼Œæ¯æ—¥è¨Šæ¯ä¸Šé™ 20 å‰‡ |
| 0-19 | é«˜åº¦å¯ç–‘ | é…å°ä¸æ¨è–¦ï¼Œåš´æ ¼è¨Šæ¯é™åˆ¶ |

**é è¨­åˆ†æ•¸**: 50ï¼ˆæ–°ç”¨æˆ¶è¨»å†Šæ™‚ï¼‰

---

## ğŸ“Š åˆ†æ•¸èª¿æ•´è¦å‰‡

### æ­£å‘è¡Œç‚ºï¼ˆåŠ åˆ†ï¼‰

| è¡Œç‚º | åˆ†æ•¸è®ŠåŒ– | è§¸ç™¼æ¢ä»¶ | å¯¦ä½œä½ç½® |
|------|----------|----------|----------|
| Email é©—è­‰å®Œæˆ | **+5** | é¦–æ¬¡é©—è­‰ Email æˆåŠŸ | `auth.py` verify_email |
| è¢«å–œæ­¡ | **+1** | å…¶ä»–ç”¨æˆ¶å–œæ­¡ä½  | `discovery.py` like_user |
| é…å°æˆåŠŸ | **+2** | é›™æ–¹äº’ç›¸å–œæ­¡ | `discovery.py` like_user |
| æ­£å‘äº’å‹• | **+1** | ç”¨æˆ¶è¼ªæµç™¼é€è¨Šæ¯æ™‚é›™æ–¹å„ç²å¾—ï¼ˆä¸Šä¸€ç™¼é€è€…â‰ ç•¶å‰ç™¼é€è€…æ‰ç®—å›æ‡‰ï¼Œæ¯é…å°æ¯æ—¥ä¸€æ¬¡ï¼Œæ¯äººæ¯æ—¥ä¸Šé™ +3ï¼‰ | `websocket.py` handle_chat_message |

### è² å‘è¡Œç‚ºï¼ˆæ‰£åˆ†ï¼‰

| è¡Œç‚º | åˆ†æ•¸è®ŠåŒ– | è§¸ç™¼æ¢ä»¶ | å¯¦ä½œä½ç½® |
|------|----------|----------|----------|
| è¢«èˆ‰å ± | **-5** | å…¶ä»–ç”¨æˆ¶èˆ‰å ±ä½  | `safety.py` report_user |
| èˆ‰å ±è¢«ç¢ºèª | **-10** | ç®¡ç†å“¡ç¢ºèªèˆ‰å ±æˆç«‹ | `admin.py` review_report |
| ç™¼é€é•è¦å…§å®¹ | **-3** | è¨Šæ¯åŒ…å«æ•æ„Ÿè©/å¯ç–‘æ¨¡å¼ | `websocket.py` handle_chat_message |
| è¢«å°é– | **-2** | å…¶ä»–ç”¨æˆ¶å°é–ä½  | `safety.py` block_user |

---

## ğŸ”§ æŠ€è¡“å¯¦ä½œ

### æœå‹™å±¤è¨­è¨ˆ

**æª”æ¡ˆä½ç½®**: `backend/app/services/trust_score.py`

#### æ ¸å¿ƒæ–¹æ³•

```python
class TrustScoreService:
    # å¸¸æ•¸å®šç¾©
    MIN_SCORE = 0
    MAX_SCORE = 100
    DEFAULT_SCORE = 50
    RESTRICTION_THRESHOLD = 20
    LOW_TRUST_MESSAGE_LIMIT = 20

    # ä¸»è¦æ–¹æ³•
    async def adjust_score(db, user_id, action, reason=None) -> int
    async def get_score(db, user_id) -> int
    async def is_restricted(db, user_id) -> bool
    async def check_message_rate_limit(user_id, trust_score, redis) -> (bool, int)
    async def record_message_sent(user_id, redis) -> int
```

### èª¿ç”¨ç¯„ä¾‹

```python
# Email é©—è­‰åŠ åˆ†
await TrustScoreService.adjust_score(db, user.id, "email_verified")

# è¢«èˆ‰å ±æ‰£åˆ†
await TrustScoreService.adjust_score(db, reported_user_id, "reported")

# æª¢æŸ¥è¨Šæ¯é™åˆ¶
can_send, remaining = await TrustScoreService.check_message_rate_limit(
    user_id, trust_score, redis
)
```

---

## ğŸ² é…å°ç®—æ³•æ•´åˆ

### æ¬Šé‡åˆ†é…ï¼ˆç¸½åˆ† 100ï¼‰

| ç¶­åº¦ | æ¬Šé‡ | èªªæ˜ |
|------|------|------|
| èˆˆè¶£åŒ¹é… | 50 åˆ† | æ¯å€‹å…±åŒèˆˆè¶£ 10 åˆ† |
| è·é›¢ | 20 åˆ† | è¶Šè¿‘åˆ†æ•¸è¶Šé«˜ |
| æ´»èºåº¦ | 20 åˆ† | æœ€è¿‘æ´»èºåˆ†æ•¸è¶Šé«˜ |
| å®Œæ•´åº¦ | 5 åˆ† | ç…§ç‰‡æ•¸é‡ + è‡ªæˆ‘ä»‹ç´¹ |
| **ä¿¡ä»»åˆ†æ•¸** | **5 åˆ†** | **æ–°å¢ç¶­åº¦** |

### ä¿¡ä»»åˆ†æ•¸æ˜ å°„

```python
trust_score >= 70  â†’  5.0 åˆ†ï¼ˆé«˜åº¦ä¿¡ä»»ï¼‰
trust_score >= 50  â†’  4.0 åˆ†ï¼ˆæ­£å¸¸ï¼‰
trust_score >= 30  â†’  2.5 åˆ†ï¼ˆéœ€é—œæ³¨ï¼‰
trust_score >= 20  â†’  1.0 åˆ†ï¼ˆå—é™ï¼‰
trust_score < 20   â†’  0.0 åˆ†ï¼ˆé«˜åº¦å¯ç–‘ï¼‰
```

**å¯¦ä½œä½ç½®**: `backend/app/services/matching_service.py` `_calculate_trust_score_weight()`

---

## ğŸš« åŠŸèƒ½é™åˆ¶æ©Ÿåˆ¶

### è¨Šæ¯ç™¼é€é™åˆ¶

**è§¸ç™¼æ¢ä»¶**: `trust_score < 20`

**é™åˆ¶å…§å®¹**:
- æ¯æ—¥è¨Šæ¯ä¸Šé™ï¼š20 å‰‡
- è¨ˆæ•¸é‡ç½®ï¼šæ¯æ—¥åˆå¤œï¼ˆUTCï¼‰
- è¶…éé™åˆ¶ï¼šæ‹’çµ•ç™¼é€ä¸¦å›å‚³éŒ¯èª¤

**Redis Key è¨­è¨ˆ**:
```
trust:daily_messages:{user_id}:{YYYY-MM-DD}
TTL: 86400 ç§’ï¼ˆ24 å°æ™‚ï¼‰
```

**å¯¦ä½œä½ç½®**: `backend/app/api/websocket.py` `handle_chat_message()`

### æª¢æŸ¥æµç¨‹

```python
1. ç”¨æˆ¶ç™¼é€è¨Šæ¯
   â†“
2. æª¢æŸ¥ trust_score
   â†“
3. è‹¥ < 20ï¼ŒæŸ¥è©¢ Redis è¨ˆæ•¸
   â†“
4. è‹¥è¶…é 20 å‰‡ï¼Œæ‹’çµ•ç™¼é€
   â†“
5. è‹¥æœªè¶…éï¼Œå¢åŠ è¨ˆæ•¸ä¸¦å…è¨±ç™¼é€
```

---

## ğŸ§ª æ¸¬è©¦è¦†è“‹

### æ¸¬è©¦æª”æ¡ˆ

**ä½ç½®**: `backend/tests/test_trust_score.py`

### æ¸¬è©¦åˆ†é¡ï¼ˆ22 å€‹æ¸¬è©¦ï¼‰

```python
TestTrustScoreAdjustments (7 å€‹)
â”œâ”€ test_email_verified_increases_score
â”œâ”€ test_received_like_increases_score
â”œâ”€ test_match_created_increases_score
â”œâ”€ test_reported_decreases_score
â”œâ”€ test_report_confirmed_decreases_score
â”œâ”€ test_content_violation_decreases_score
â””â”€ test_blocked_decreases_score

TestScoreBoundaries (3 å€‹)
â”œâ”€ test_score_never_exceeds_max
â”œâ”€ test_score_never_below_min
â””â”€ test_invalid_action_raises_error

TestGetScore (2 å€‹)
â”œâ”€ test_get_score_returns_current_score
â””â”€ test_get_score_user_not_found

TestRestrictions (3 å€‹)
â”œâ”€ test_normal_user_not_restricted
â”œâ”€ test_low_trust_user_is_restricted
â””â”€ test_boundary_score_not_restricted

TestMessageRateLimiting (4 å€‹)
â”œâ”€ test_normal_user_no_limit
â”œâ”€ test_low_trust_user_has_limit
â”œâ”€ test_exceeded_limit_blocks_message
â””â”€ test_record_message_increments_counter

TestMultipleAdjustments (3 å€‹)
â”œâ”€ test_cumulative_positive_adjustments
â”œâ”€ test_cumulative_negative_adjustments
â””â”€ test_mixed_adjustments
```

### æ¸¬è©¦åŸ·è¡Œ

```bash
# åŸ·è¡Œæ‰€æœ‰ä¿¡ä»»åˆ†æ•¸æ¸¬è©¦
pytest tests/test_trust_score.py -v

# æ¸¬è©¦çµæœ
22 passed
```

### æ•´åˆæ¸¬è©¦

é©—è­‰å„ API ç«¯é»è§¸ç™¼åˆ†æ•¸èª¿æ•´ï¼š

```bash
# Email é©—è­‰æ¸¬è©¦
pytest tests/test_auth.py::test_verify_email_success -v

# é…å°æ¸¬è©¦
pytest tests/test_discovery.py::test_mutual_like_creates_match -v

# èˆ‰å ±æ¸¬è©¦
pytest tests/test_safety.py::test_report_user_success -v
```

---

## ğŸ”„ å·¥ä½œæµç¨‹ç¯„ä¾‹

### å ´æ™¯ 1ï¼šæ­£å¸¸ç”¨æˆ¶æˆé•·è·¯å¾‘

```
æ–°ç”¨æˆ¶è¨»å†Š
â”œâ”€ åˆå§‹åˆ†æ•¸: 50
â”œâ”€ Email é©—è­‰: +5 â†’ 55
â”œâ”€ è¢« 3 äººå–œæ­¡: +3 â†’ 58
â”œâ”€ é…å°æˆåŠŸ 2 æ¬¡: +4 â†’ 62
â””â”€ æœ€çµ‚åˆ†æ•¸: 62ï¼ˆæ­£å¸¸ç”¨æˆ¶ï¼‰
```

### å ´æ™¯ 2ï¼šé•è¦ç”¨æˆ¶é™ç´šè·¯å¾‘

```
æ­£å¸¸ç”¨æˆ¶
â”œâ”€ åˆå§‹åˆ†æ•¸: 50
â”œâ”€ ç™¼é€é•è¦å…§å®¹: -3 â†’ 47
â”œâ”€ è¢«èˆ‰å ± 2 æ¬¡: -10 â†’ 37
â”œâ”€ èˆ‰å ±è¢«ç¢ºèª: -10 â†’ 27
â””â”€ æœ€çµ‚åˆ†æ•¸: 27ï¼ˆéœ€é—œæ³¨ï¼‰
```

### å ´æ™¯ 3ï¼šåš´é‡é•è¦ç”¨æˆ¶

```
å•é¡Œç”¨æˆ¶
â”œâ”€ åˆå§‹åˆ†æ•¸: 50
â”œâ”€ è¢«èˆ‰å ± 3 æ¬¡: -15 â†’ 35
â”œâ”€ èˆ‰å ±ç¢ºèª 2 æ¬¡: -20 â†’ 15
â”œâ”€ è¢«å°é– 3 æ¬¡: -6 â†’ 9
â””â”€ æœ€çµ‚åˆ†æ•¸: 9ï¼ˆå—é™æ¨¡å¼ï¼‰
    â”œâ”€ é…å°æ’åºæ¥µä½
    â”œâ”€ æ¯æ—¥è¨Šæ¯ä¸Šé™ 20 å‰‡
    â””â”€ å»ºè­°ç®¡ç†å“¡å¯©æŸ¥
```

---

## ğŸ›¡ï¸ å®‰å…¨è€ƒé‡

### 1. ä¸¦ç™¼å®‰å…¨

æ‰€æœ‰åˆ†æ•¸èª¿æ•´ä½¿ç”¨è³‡æ–™åº«äº‹å‹™ä¿è­‰åŸå­æ€§ï¼š

```python
async def adjust_score(...):
    # æŸ¥è©¢ç”¨æˆ¶
    user = await db.execute(select(User).where(User.id == user_id))

    # è¨ˆç®—æ–°åˆ†æ•¸
    new_score = user.trust_score + adjustment

    # æ›´æ–°åˆ†æ•¸ï¼ˆäº‹å‹™ä¿è­‰ï¼‰
    user.trust_score = new_score
    await db.commit()  # åŸå­æ“ä½œ
```

### 2. åˆ†æ•¸é‚Šç•Œä¿è­·

```python
# ç¢ºä¿åˆ†æ•¸åœ¨ 0-100 ç¯„åœå…§
new_score = max(MIN_SCORE, min(MAX_SCORE, new_score))
```

### 3. Redis å¿«å–å¤±æ•—å›é€€

è¨Šæ¯é™åˆ¶åŠŸèƒ½åœ¨ Redis ç•°å¸¸æ™‚è‡ªå‹•å›é€€ï¼Œä¸å½±éŸ¿æ­£å¸¸ç”¨æˆ¶ï¼š

```python
try:
    # Redis æ“ä½œ
    ...
except Exception:
    # ç•°å¸¸æ™‚å…è¨±ç™¼é€ï¼ˆä¸é˜»æ“‹ç”¨æˆ¶ï¼‰
    return True, None
```

---

## ğŸ”® æœªä¾†æ“´å±•

è©³è¦‹ **[ROADMAP.md](ROADMAP.md#ä¿¡ä»»åˆ†æ•¸ç³»çµ±å¢å¼·)**

---

## ğŸ§® é…å°æ’åºå½±éŸ¿ç¯„ä¾‹

### ç¯„ä¾‹å€™é¸äººæ¯”è¼ƒ

**ç”¨æˆ¶ A** (é«˜ä¿¡ä»»åº¦)
```
èˆˆè¶£åŒ¹é…: 30 åˆ†ï¼ˆ3 å€‹å…±åŒèˆˆè¶£ï¼‰
è·é›¢: 15 åˆ†ï¼ˆ8 kmï¼‰
æ´»èºåº¦: 20 åˆ†ï¼ˆ30 åˆ†é˜å‰ï¼‰
å®Œæ•´åº¦: 5 åˆ†ï¼ˆ6 å¼µç…§ç‰‡ + è‡ªä»‹ï¼‰
ä¿¡ä»»åˆ†æ•¸: 5 åˆ†ï¼ˆtrust_score = 75ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½åˆ†: 75 åˆ†
```

**ç”¨æˆ¶ B** (ä½ä¿¡ä»»åº¦)
```
èˆˆè¶£åŒ¹é…: 30 åˆ†ï¼ˆ3 å€‹å…±åŒèˆˆè¶£ï¼‰
è·é›¢: 15 åˆ†ï¼ˆ8 kmï¼‰
æ´»èºåº¦: 20 åˆ†ï¼ˆ30 åˆ†é˜å‰ï¼‰
å®Œæ•´åº¦: 5 åˆ†ï¼ˆ6 å¼µç…§ç‰‡ + è‡ªä»‹ï¼‰
ä¿¡ä»»åˆ†æ•¸: 0 åˆ†ï¼ˆtrust_score = 15ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½åˆ†: 70 åˆ†
```

**çµæœ**: ç”¨æˆ¶ A æ’åºå„ªå…ˆæ–¼ç”¨æˆ¶ Bï¼ˆå³ä½¿å…¶ä»–æ¢ä»¶ç›¸åŒï¼‰

---

## ğŸ› å·²çŸ¥é™åˆ¶

1. **ç„¡è‡ªå‹•æ¢å¾©æ©Ÿåˆ¶**
   - æ²’æœ‰éš¨æ™‚é–“è‡ªå‹•æ¢å¾©æ©Ÿåˆ¶
   - ç”¨æˆ¶éœ€é€éæ­£å‘è¡Œç‚ºï¼ˆè¢«å–œæ­¡ã€é…å°æˆåŠŸï¼‰æ‰‹å‹•æå‡

2. **ç„¡æ­·å²è¨˜éŒ„**
   - ä¸è¨˜éŒ„åˆ†æ•¸è®ŠåŒ–æ­·å²
   - ç„¡æ³•è¿½è¹¤å…·é«”æ‰£åˆ†åŸå› 

3. **å–®ä¸€é–¾å€¼**
   - åƒ…æœ‰ä¸€å€‹é™åˆ¶é–¾å€¼ï¼ˆ20 åˆ†ï¼‰
   - æœªä¾†å¯è€ƒæ…®å¤šç´šé™åˆ¶
