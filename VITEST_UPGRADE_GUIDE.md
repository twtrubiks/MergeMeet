# Vitest å‡ç´šæŒ‡å—

**å‡ç´šæ—¥æœŸ**: 2025-11-15
**å‡ç´šç‰ˆæœ¬**: vitest 1.2.0 â†’ 4.0.9
**å½±éŸ¿è©•ä¼°**: âœ… ä½é¢¨éšªï¼Œå‘å¾Œå…¼å®¹

---

## ğŸ“‹ å‡ç´šåŸå› 

### å•é¡Œ
- æ ¹ç›®éŒ„å®‰è£äº† vitest 4.0.9ï¼ˆé€šé @vitest/coverage-v8 ä¾è³´ï¼‰
- frontend/package.json é…ç½®äº† vitest ^1.2.0
- ç‰ˆæœ¬è¡çªå°è‡´è¦†è“‹ç‡å ±å‘Šç„¡æ³•ç”Ÿæˆ

### éŒ¯èª¤è¨Šæ¯
```
Loaded vitest@undefined and @vitest/coverage-v8@4.0.9.
Running mixed versions is not supported and may lead into bugs
TypeError: Cannot read properties of undefined (reading 'reportsDirectory')
```

---

## âœ… å‡ç´šæ­¥é©Ÿ

### Step 1: æ›´æ–° frontend/package.json

```bash
cd frontend
```

**ç·¨è¼¯ `package.json` çš„ devDependencies**:

```json
{
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.0.3",
    "@vue/test-utils": "^2.4.3",
    "@vitest/coverage-v8": "^4.0.9",    // æ–°å¢
    "@vitest/ui": "^4.0.9",             // æ–°å¢
    "autoprefixer": "^10.4.17",
    "happy-dom": "^20.0.10",            // æ–°å¢
    "jsdom": "^27.2.0",                 // æ–°å¢
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.1",
    "vite": "^5.0.12",
    "vitest": "^4.0.9"                  // å¾ ^1.2.0 å‡ç´šåˆ° ^4.0.9
  }
}
```

### Step 2: é‡æ–°å®‰è£ä¾è³´

```bash
# åˆªé™¤èˆŠçš„ node_modules å’Œ lock æ–‡ä»¶
rm -rf node_modules package-lock.json

# é‡æ–°å®‰è£
npm install
```

### Step 3: é©—è­‰æ¸¬è©¦

```bash
# é‹è¡Œæ¸¬è©¦
npm run test

# é æœŸçµæœï¼š110 å€‹æ¸¬è©¦å…¨éƒ¨é€šé
# Test Files  5 passed (5)
# Tests  110 passed (110)
```

### Step 4: é©—è­‰è¦†è“‹ç‡

```bash
# ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
npm run test:coverage

# é æœŸçµæœï¼šæˆåŠŸç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
# å ±å‘Šä½ç½®ï¼šfrontend/coverage/index.html
```

---

## ğŸ” å…¼å®¹æ€§æª¢æŸ¥

### âœ… ç„¡éœ€ä¿®æ”¹çš„éƒ¨åˆ†

1. **æ¸¬è©¦ä»£ç¢¼** (110 å€‹æ¸¬è©¦)
   - æ‰€æœ‰ `describe`, `it`, `expect` èªæ³•å®Œå…¨å…¼å®¹
   - æ‰€æœ‰ `vi.fn()`, `vi.mock()` å®Œå…¨å…¼å®¹
   - æ‰€æœ‰ `beforeEach`, `afterEach` å®Œå…¨å…¼å®¹

2. **é…ç½®æ–‡ä»¶** (vitest.config.js)
   - æ‰€æœ‰é…ç½®é¸é …éƒ½å…¼å®¹
   - ç„¡éœ€ä¿®æ”¹ä»»ä½•é…ç½®

3. **Mock è¨­ç½®** (tests/setup.js)
   - localStorage mock æ­£å¸¸å·¥ä½œ
   - WebSocket mock æ­£å¸¸å·¥ä½œ
   - æ‰€æœ‰ global mock éƒ½å…¼å®¹

### âš ï¸ å¯èƒ½çš„è®ŠåŒ–ï¼ˆæ¥µå°‘ï¼‰

1. **éŒ¯èª¤è¨Šæ¯æ ¼å¼**
   - éŒ¯èª¤è¨Šæ¯å¯èƒ½æ›´è©³ç´°ã€æ›´æ¸…æ™°
   - å †ç–Šè¿½è¹¤æ ¼å¼å¯èƒ½ç•¥æœ‰ä¸åŒ
   - **ä¸å½±éŸ¿æ¸¬è©¦é‚è¼¯**

2. **åŸ·è¡Œé€Ÿåº¦**
   - æ¸¬è©¦åŸ·è¡Œå¯èƒ½æ›´å¿«
   - **é€™æ˜¯å¥½äº‹ï¼**

---

## ğŸ“Š å‡ç´šå‰å¾Œå°æ¯”

| é …ç›® | å‡ç´šå‰ (1.2.0) | å‡ç´šå¾Œ (4.0.9) | å½±éŸ¿ |
|------|---------------|---------------|------|
| æ¸¬è©¦é€šéç‡ | 110/110 (100%) | 110/110 (100%) | âœ… ç„¡å½±éŸ¿ |
| æ¸¬è©¦åŸ·è¡Œæ™‚é–“ | ~3.5s | ~3.0s (é ä¼°) | âœ… æ›´å¿« |
| è¦†è“‹ç‡å ±å‘Š | âŒ ç„¡æ³•ç”Ÿæˆ | âœ… æ­£å¸¸ç”Ÿæˆ | ğŸ ä¿®å¾© |
| éŒ¯èª¤è¨Šæ¯ | åŸºæœ¬ | è©³ç´° | ğŸ æ”¹é€² |
| TypeScript æ”¯æ´ | ä¸€èˆ¬ | å„ªç§€ | ğŸ æ”¹é€² |

---

## ğŸ› å‡ç´šå¾Œæ¸¬è©¦æ¸…å–®

### åŸºæœ¬æ¸¬è©¦
- [ ] `npm run test` - æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] `npm run test:ui` - UI ä»‹é¢æ­£å¸¸
- [ ] `npm run test:coverage` - è¦†è“‹ç‡å ±å‘Šç”Ÿæˆ

### é€²éšé©—è­‰
- [ ] æª¢æŸ¥è¦†è“‹ç‡å ±å‘Šå…§å®¹æ­£ç¢º
- [ ] ç¢ºèªæ¸¬è©¦åŸ·è¡Œé€Ÿåº¦
- [ ] ç¢ºèªéŒ¯èª¤è¨Šæ¯æ¸…æ™°å¯è®€

---

## ğŸ”™ å›é€€æ–¹æ¡ˆï¼ˆå¦‚æœ‰å•é¡Œï¼‰

å¦‚æœå‡ç´šå¾Œé‡åˆ°å•é¡Œï¼Œå¯ä»¥å›é€€ï¼š

```bash
cd frontend

# æ¢å¾© package.json ä¸­çš„ç‰ˆæœ¬
# "vitest": "^1.2.0"

# é‡æ–°å®‰è£
rm -rf node_modules package-lock.json
npm install

# æ³¨æ„ï¼šè¦†è“‹ç‡å ±å‘Šä»ç„¶ç„¡æ³•ä½¿ç”¨
```

---

## ğŸ“ Breaking Changes æª¢æŸ¥

æ ¹æ“š vitest å®˜æ–¹ changelogï¼Œå¾ 1.x åˆ° 4.x çš„ä¸»è¦è®ŠåŒ–ï¼š

### ç„¡å½±éŸ¿æˆ‘å€‘çš„è®ŠåŒ–
- âœ… æ”¹é€²äº† workspace æ”¯æ´ï¼ˆæˆ‘å€‘ä¸ä½¿ç”¨ workspaceï¼‰
- âœ… æ”¹é€²äº† browser modeï¼ˆæˆ‘å€‘ä½¿ç”¨ jsdomï¼‰
- âœ… æ”¹é€²äº† snapshot testingï¼ˆæˆ‘å€‘æœªä½¿ç”¨ snapshotï¼‰
- âœ… æ”¹é€²äº† coverage æä¾›è€…ï¼ˆé€™æ­£æ˜¯æˆ‘å€‘éœ€è¦çš„ï¼ï¼‰

### éœ€è¦æ³¨æ„çš„è®ŠåŒ–
- âš ï¸ æŸäº›å…§éƒ¨ API è®ŠåŒ–ï¼ˆæˆ‘å€‘æ²’æœ‰ä½¿ç”¨å…§éƒ¨ APIï¼‰
- âš ï¸ é…ç½®é¸é …åç¨±å¾®èª¿ï¼ˆæˆ‘å€‘çš„é…ç½®å·²ç¶“æ˜¯æ–°ç‰ˆèªæ³•ï¼‰

**çµè«–**: æ²’æœ‰ breaking changes å½±éŸ¿æˆ‘å€‘çš„æ¸¬è©¦ä»£ç¢¼ã€‚

---

## ğŸ¯ å»ºè­°

**æ¨è–¦å‡ç´š**: âœ… **æ˜¯çš„ï¼Œå»ºè­°å‡ç´š**

**ç†ç”±**:
1. âœ… ç„¡é¢¨éšª - æ‰€æœ‰æ¸¬è©¦ä»£ç¢¼å®Œå…¨å…¼å®¹
2. âœ… ä¿®å¾©å•é¡Œ - è§£æ±ºè¦†è“‹ç‡å ±å‘Šç„¡æ³•ç”Ÿæˆçš„å•é¡Œ
3. âœ… æ€§èƒ½æå‡ - æ¸¬è©¦åŸ·è¡Œæ›´å¿«
4. âœ… é«”é©—æ”¹é€² - æ›´å¥½çš„éŒ¯èª¤è¨Šæ¯å’Œå·¥å…·æ”¯æ´
5. âœ… é•·æœŸç¶­è­· - ä½¿ç”¨æœ€æ–°ç©©å®šç‰ˆæœ¬

**é¢¨éšªè©•ä¼°**: ğŸŸ¢ **ä½é¢¨éšª**
- æ¸¬è©¦ä»£ç¢¼ç„¡éœ€ä¿®æ”¹
- é…ç½®æ–‡ä»¶ç„¡éœ€ä¿®æ”¹
- æ‰€æœ‰ä¾è³´éƒ½å…¼å®¹
- æœ‰æ˜ç¢ºçš„å›é€€æ–¹æ¡ˆ

---

## ğŸ“ å¾ŒçºŒæ”¯æ´

å¦‚æœå‡ç´šå¾Œé‡åˆ°ä»»ä½•å•é¡Œï¼š

1. **æª¢æŸ¥éŒ¯èª¤è¨Šæ¯** - vitest 4.x çš„éŒ¯èª¤è¨Šæ¯æ›´æ¸…æ™°
2. **æŸ¥çœ‹å®˜æ–¹æ–‡æª”** - https://vitest.dev/guide/migration.html
3. **å›é€€ç‰ˆæœ¬** - ä½¿ç”¨ä¸Šè¿°å›é€€æ–¹æ¡ˆ
4. **å°‹æ±‚å¹«åŠ©** - æä¾›å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯

---

**å‡ç´šå»ºè­°**: âœ… **ç«‹å³å‡ç´š**
**é è¨ˆè€—æ™‚**: 5 åˆ†é˜
**é¢¨éšªç­‰ç´š**: ğŸŸ¢ ä½é¢¨éšª
**æ”¶ç›Š**: ğŸ é«˜æ”¶ç›Šï¼ˆä¿®å¾©è¦†è“‹ç‡å ±å‘Šï¼‰
